<!DOCTYPE html>
<html>
<head>
    <title>Fix Owner Account</title>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // Your Firebase config (from .env)
        const firebaseConfig = {
            apiKey: "AIzaSyDx42jPBpKMoFXfVUSuilBYTV1lpLaCsqc",
            authDomain: "kamdon-poject.firebaseapp.com",
            projectId: "kamdon-poject",
            storageBucket: "kamdon-poject.firebasestorage.app",
            messagingSenderId: "276247982921",
            appId: "1:276247982921:web:90cb988a252d4a3539e098"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const log = (msg) => {
            const output = document.getElementById('output');
            output.innerHTML += msg + '<br>';
            console.log(msg);
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                log('‚úÖ Logged in as: ' + user.email);
                log('User ID: ' + user.uid);
                
                try {
                    // Get current user document
                    const userRef = doc(db, 'users', user.uid);
                    const userDoc = await getDoc(userRef);
                    
                    if (!userDoc.exists()) {
                        log('‚ùå User document not found in Firestore!');
                        log('Creating user document...');
                        
                        await setDoc(userRef, {
                            email: user.email,
                            name: user.displayName || user.email.split('@')[0],
                            role: 'owner',
                            isActive: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        });
                        
                        log('‚úÖ User document created!');
                    } else {
                        const userData = userDoc.data();
                        log('Current user data: ' + JSON.stringify(userData, null, 2));
                        
                        if (userData.isActive === undefined || userData.isActive === false) {
                            log('‚ö†Ô∏è isActive field is missing or false. Fixing...');
                            
                            await setDoc(userRef, {
                                isActive: true,
                                updatedAt: new Date().toISOString()
                            }, { merge: true });
                            
                            log('‚úÖ User updated with isActive: true');
                            
                            // Verify
                            const updatedDoc = await getDoc(userRef);
                            log('Updated user data: ' + JSON.stringify(updatedDoc.data(), null, 2));
                        } else {
                            log('‚úÖ User already has isActive: true');
                        }
                        
                        if (userData.role !== 'owner') {
                            log('‚ö†Ô∏è User role is not owner. Current role: ' + userData.role);
                            log('Setting role to owner...');
                            
                            await setDoc(userRef, {
                                role: 'owner',
                                updatedAt: new Date().toISOString()
                            }, { merge: true });
                            
                            log('‚úÖ User role updated to owner');
                        }
                    }
                    
                    log('');
                    log('üéâ All done! Refresh your dashboard and try again.');
                    
                } catch (error) {
                    log('‚ùå Error: ' + error.message);
                    console.error(error);
                }
            } else {
                log('‚ùå Not logged in. Please login first at /login');
            }
        });
    </script>
    <style>
        body {
            font-family: monospace;
            padding: 40px;
            background: #1e293b;
            color: #e2e8f0;
        }
        h1 {
            color: #60a5fa;
        }
        #output {
            background: #0f172a;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #334155;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        .warning {
            color: #fbbf24;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Fix Owner Account - isActive Field</h1>
    <p class="warning">‚ö†Ô∏è Make sure you're logged in as the owner account first!</p>
    <div id="output">Checking authentication...</div>
</body>
</html>
